<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Folder - {{ folder.name }}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    .file-card, .folder-card {
      width: 160px;
      text-align: center;
      margin: 10px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 10px;
      background-color: white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      transition: all 0.2s ease;
      cursor: pointer;
    }
    .file-card:hover, .folder-card:hover {
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    .file-preview {
      max-height: 80px;
      margin-bottom: 5px;
    }
    .folder-grid, .file-grid {
      display: flex;
      flex-wrap: wrap;
    }
    .action-buttons {
      margin-top: 5px;
    }
    .pagination {
      justify-content: center;
    }
  </style>
</head>
<body class="bg-light">

<div class="container py-5">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="text-primary">üìÅ {{ folder.name }}</h2>
    <div>
      <a href="/dashboard" class="btn btn-outline-secondary me-2">‚Üê Dashboard</a>
      <a href="/logout" class="btn btn-outline-danger">Logout</a>
    </div>
  </div>

  {% if subfolders %}
    <h5 class="mb-3">üìÇ Subfolders</h5>
    <div class="folder-grid mb-4">
      {% for sub in subfolders %}
      <div class="folder-card" data-id="{{ sub.id }}" onclick="window.location.href='{{ url_for('folder_view', folder_id=sub.id) }}'">
        <i class="bi bi-folder-fill text-warning" style="font-size: 2rem;"></i>
        <div class="fw-bold mt-1 folder-name">{{ sub.name }}</div>
        <small class="text-muted">üìÖ {{ sub.created_at.strftime('%Y-%m-%d') if sub.created_at else '' }}</small>
      </div>
      {% endfor %}
    </div>
  {% endif %}

  <form method="post" class="row g-2 mb-4">
    <div class="col-md-8">
      <input name="subfolder_name" class="form-control" placeholder="Create subfolder" required>
    </div>
    <div class="col-md-4">
      <button type="submit" class="btn btn-outline-success w-100">Add Subfolder</button>
    </div>
  </form>

  <form method="post" enctype="multipart/form-data" class="row g-3 mb-4">
    <div class="col-md-8">
      <input type="file" name="file" class="form-control" accept=".jpg,.jpeg,.png,.gif,.bmp,.pdf,.doc,.docx" required>
    </div>
    <div class="col-md-4">
      <button type="submit" class="btn btn-success w-100">Upload File</button>
    </div>
  </form>

  {% if files %}
    <h5 class="mb-3">üìÑ Files</h5>
    <div class="file-grid">
      {% for file in files %}
      <div class="file-card">
        {% if file.filename.endswith(('.png', '.jpg', '.jpeg', '.gif')) %}
          <img src="{{ file.public_url }}" class="file-preview img-thumbnail">
        {% elif file.filename.endswith('.pdf') %}
          <i class="bi bi-file-earmark-pdf text-danger" style="font-size: 2rem;"></i>
        {% elif file.filename.endswith(('.doc', '.docx')) %}
          <i class="bi bi-file-earmark-word text-primary" style="font-size: 2rem;"></i>
        {% else %}
          <i class="bi bi-file-earmark" style="font-size: 2rem;"></i>
        {% endif %}
        <div class="mt-2 small fw-bold text-break">{{ file.filename[:20] }}{% if file.filename|length > 20 %}...{% endif %}</div>
        <small class="text-muted">{{ '%.2f' % (file.size / (1024 * 1024)) }} MB</small>
        <div class="action-buttons">
          <a href="{{ file.public_url }}" target="_blank" class="btn btn-sm btn-outline-primary mb-1">View</a>
          <button class="btn btn-sm btn-outline-secondary mb-1" onclick="copyToClipboard('{{ file.public_url }}')">Copy</button>
          <form method="post" action="{{ url_for('delete_file', file_id=file.id, folder_id=folder.id) }}" style="display:inline;">
            <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Delete this file?')">Delete</button>
          </form>
        </div>
      </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="alert alert-info">No files uploaded yet.</div>
  {% endif %}
</div>

<div id="contextMenu" class="position-absolute bg-white border rounded shadow-sm p-2" style="display:none; z-index:999; width:200px;">
  <input type="text" id="renameInput" class="form-control form-control-sm mb-2" placeholder="Rename folder">
  <button class="btn btn-sm btn-outline-secondary w-100 mb-2" onclick="submitRename()">Rename</button>
  <button class="btn btn-sm btn-outline-success w-100 mb-2" onclick="submitZip()">Download ZIP</button>
  <button class="btn btn-sm btn-outline-danger w-100" onclick="submitDelete()">Delete Folder</button>
</div>

<script>
  let selectedFolderId = null;

  document.addEventListener('contextmenu', function (e) {
    const card = e.target.closest('.folder-card');
    if (card) {
      e.preventDefault();
      selectedFolderId = card.getAttribute('data-id');
      const menu = document.getElementById('contextMenu');
      const input = document.getElementById('renameInput');
      input.value = card.querySelector('.folder-name').textContent;
      menu.style.top = e.pageY + 'px';
      menu.style.left = e.pageX + 'px';
      menu.style.display = 'block';
      input.focus();
    } else {
      hideContextMenu();
    }
  });

  document.addEventListener('click', function (e) {
    const menu = document.getElementById('contextMenu');
    if (!menu.contains(e.target)) {
      hideContextMenu();
    }
  });

  function hideContextMenu() {
    document.getElementById('contextMenu').style.display = 'none';
  }

  function submitRename() {
    const newName = document.getElementById('renameInput').value;
    fetch(`/folder/${selectedFolderId}/rename`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ new_name: newName })
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) location.reload();
      else alert('Rename failed.');
    });
  }

  function submitDelete() {
    if (!confirm("Are you sure you want to delete this folder and all its contents?")) return;
    fetch(`/folder/${selectedFolderId}/delete`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) location.reload();
      else alert('Delete failed.');
    });
  }

  function submitZip() {
    window.location.href = `/folder/${selectedFolderId}/download`;
  }

  function copyToClipboard(url) {
    navigator.clipboard.writeText(url).then(() => {
      alert('Public URL copied!');
    });
  }
</script>

</body>
</html>
